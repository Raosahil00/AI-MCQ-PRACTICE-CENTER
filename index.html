<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI MCQ Practice Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- MathJax for beautiful math rendering -->
    <script>
      MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']]
        },
        svg: {
          fontCache: 'global'
        }
      };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    <style>
        /* APPLE-INSPIRED PREMIUM DESIGN PALETTE */
        :root {
            --bg-gradient: linear-gradient(120deg, #E6E9F0, #EEF1F5); /* Platinum Glow */
            --footer-gradient: linear-gradient(to right, #232526, #414345); /* Mystic Noir */
            --accent-gradient: linear-gradient(to right, #F7971E, #FFD200); /* Luxury Gold Accent */
            --highlight-gradient: linear-gradient(to right, #A1C4FD, #C2E9FB); /* Serene Blue Mist */
            
            --card-bg: rgba(255, 255, 255, 0.65);
            --heading-text: #232526;
            --body-text: #414345;
            --border-color: rgba(0, 0, 0, 0.07);

            --success-color: #28a745;
            --error-color: #dc3545;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-gradient);
            color: var(--body-text);
        }

        h1, h2, h3, h4, h5, h6, .font-bold {
             font-family: 'Playfair Display', serif;
             color: var(--heading-text);
        }

        .transition-all {
            transition: all 0.3s ease-in-out;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 1.5rem;
            box-shadow: 0 25px 50px -20px rgba(0, 0, 0, 0.1);
            padding: 3.5rem;
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .btn {
            padding: 0.8rem 1.75rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
            text-align: center;
            cursor: pointer;
            transition: all 0.25s ease-out;
            letter-spacing: 0.5px;
            border: none;
        }

        .btn-primary {
            background: var(--accent-gradient);
            color: #0D1B2A;
            box-shadow: 0 5px 20px -5px rgba(247, 151, 30, 0.4);
            transform: translateY(0);
        }

        .btn-primary:hover {
            box-shadow: 0 0 25px rgba(255, 210, 0, 0.6);
            transform: translateY(-3px) scale(1.03);
        }

         .btn-primary:disabled {
            background: #EAEAEA;
            color: #A0A0A0;
            cursor: not-allowed;
            transform: translateY(0);
            box-shadow: none;
        }

        .btn-secondary {
            background-color: rgba(255, 255, 255, 0.7);
            color: var(--heading-text);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background-color: #FFFFFF;
            border-color: var(--heading-text);
        }

        .input-field {
            width: 100%;
            padding: 0.85rem 1.15rem;
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            transition: all 0.2s ease-in-out;
            background-color: rgba(255, 255, 255, 0.8);
            color: var(--body-text);
            font-size: 1rem;
        }

        .input-field:focus {
            outline: none;
            border-color: #F7971E;
            box-shadow: 0 0 0 4px rgba(247, 151, 30, 0.15);
        }

        .tab-btn-container {
             background-color: #E6E9F0;
             padding: 0.35rem;
             border-radius: 0.75rem;
        }

        .tab-btn {
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            color: var(--body-text);
            border: none;
            background: transparent;
        }

        .tab-btn.active {
            background: var(--accent-gradient);
            color: #0D1B2A;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .option {
            transition: all 0.2s ease-in-out;
            border: 1px solid var(--border-color);
            background-color: #FFFFFF;
            border-radius: 0.75rem;
        }
        
        .option:hover {
            border-color: #FFD200;
            transform: translateY(-2px);
        }

        .option.selected {
            background-color: #fffaf0;
            border-color: #F7971E;
            transform: scale(1.02);
            box-shadow: 0 4px 20px -5px rgba(247, 151, 30, 0.3);
        }
        
        .option.correct { background-color: #e9f7ec; border-color: var(--success-color); }
        .option.incorrect { background-color: #fbe9e9; border-color: var(--error-color); }
        .option.correct-answer { border-color: #F7971E; box-shadow: 0 0 0 2px #FFD200; }

        .result-box {
            background: #FFFFFF;
            border: 1px solid var(--border-color);
            border-radius: 1rem;
        }

        .goal-analysis-box {
            border-radius: 1rem;
            padding: 1.5rem;
        }

        .loader {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(0, 0, 0, 0.6);
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #pdfFileName.font-semibold {
            color: var(--heading-text);
        }
        
        #horizontalNavContainer {
            overflow-x: auto;
            padding-bottom: 1rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border-color);
        }
       
        #horizontalNavContainer::-webkit-scrollbar { height: 4px; }
        #horizontalNavContainer::-webkit-scrollbar-track { background: transparent; }
        #horizontalNavContainer::-webkit-scrollbar-thumb { background: #E6E9F0; border-radius: 10px; }
        #horizontalNavContainer::-webkit-scrollbar-thumb:hover { background: #F7971E; }

        #questionNavGrid {
            display: flex;
            gap: 0.75rem;
            padding: 0.5rem 0;
        }
        .nav-item {
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: #FFFFFF;
            border: 1px solid var(--border-color);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .nav-item:hover {
            transform: scale(1.1);
            border-color: #F7971E;
        }
        .nav-item.attempted {
            background: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }
        .nav-item.skipped {
            background-color: var(--error-color);
            color: white;
            border-color: var(--error-color);
        }
        .nav-item.current {
            box-shadow: 0 0 0 3px #FFD200;
            border-color: #F7971E;
        }
        #categoryFilters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 2rem;
        }
        .category-btn {
            background: #FFFFFF;
            border: 1px solid var(--border-color);
            color: var(--body-text);
            padding: 0.5rem 1.25rem;
            border-radius: 999px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .category-btn:hover {
            background-color: white;
            border-color: var(--body-text);
        }
        .category-btn.active {
            background: var(--accent-gradient);
            color: #0D1B2A;
            border-color: transparent;
            font-weight: 600;
        }
        
        .difficulty-tag {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .difficulty-easy { background: #e9f7ec; color: #1a7e63; }
        .difficulty-medium { background: #fffbeb; color: #b45309; }
        .difficulty-hard { background: #fbe9e9; color: #c53030; }

        #explanationBox {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: #F9FAFC;
            border-radius: 1rem;
            border: 1px solid var(--border-color);
            animation: fadeIn 0.4s ease;
        }
        #explanationBox h4 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }

        footer {
            background: var(--footer-gradient);
            color: #E6E9F0;
            padding: 2rem;
            border-radius: 1rem;
            margin-top: 2rem;
        }
        
        /* Modal Styles */
        #goalModal {
            position: fixed;
            inset: 0;
            background-color: rgba(13, 27, 42, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease;
        }
        #goalModal .card {
             width: 100%;
             max-width: 600px;
        }
        
        /* Practice Mode Toggle Switch */
        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #E6E9F0;
            padding: 1rem;
            border-radius: 0.75rem;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-image: var(--accent-gradient);
        }
        input:checked + .slider:before {
            transform: translateX(22px);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 sm:p-6 lg:p-8">

    <div class="w-full max-w-5xl mx-auto">
        <!-- Setup Screen -->
        <div id="setupScreen" class="card space-y-12 max-w-4xl mx-auto">
            <div class="text-center">
                 <div class="flex justify-center items-center gap-4">
                     <div class="p-3 rounded-full" style="background: var(--accent-gradient)">
                         <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#0D1B2A" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-[#D4AF37]"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><path d="m9 12 2 2 4-4"></path></svg>
                     </div>
                    <h1 class="text-5xl font-bold">AI MCQ Practice Center</h1>
                </div>
                <p class="text-xl mt-4 max-w-2xl mx-auto">The premium way to prepare. Generate, practice, and analyze with an elegant, AI-powered experience.</p>
            </div>

            <!-- Question Input -->
            <div class="border-t border-[#EFEBE4] pt-8">
                <h2 class="text-3xl font-semibold mb-6 text-center">Create Your Question Bank</h2>
                <div class="flex flex-wrap space-x-2 tab-btn-container p-1 rounded-lg mb-6">
                    <button id="generateTab" class="tab-btn flex-1 text-center active" onclick="switchTab('generate')">Generate from Text</button>
                    <button id="pdfTab" class="tab-btn flex-1 text-center" onclick="switchTab('pdf')">Upload PDF</button>
                    <button id="manualTab" class="tab-btn flex-1 text-center" onclick="switchTab('manual')">Manual Entry</button>
                </div>

                <!-- AI Generation Form -->
                <div id="generateInput" class="space-y-6">
                    <div>
                        <label for="aiTopic" class="block text-sm font-medium mb-2">Topic or Subject</label>
                        <input type="text" id="aiTopic" class="input-field" placeholder="e.g., Quantum Physics, Renaissance Art">
                    </div>
                    <div>
                        <label for="aiContext" class="block text-sm font-medium mb-2">Context / Paragraph (Optional)</label>
                        <textarea id="aiContext" class="input-field h-24" placeholder="Paste a paragraph here or upload a PDF to populate this field."></textarea>
                    </div>
                     <div>
                        <label for="aiStyle" class="block text-sm font-medium mb-2">Question Style / Instructions (Optional)</label>
                        <input type="text" id="aiStyle" class="input-field" placeholder="e.g., create case-study problems, focus on key theorists">
                    </div>
                    <div>
                        <label for="aiExamples" class="block text-sm font-medium mb-2">Example Questions (Optional)</label>
                        <textarea id="aiExamples" class="input-field h-24" placeholder="Provide 1-2 examples in the correct format to guide the AI."></textarea>
                    </div>
                    <div class="flex items-center gap-4 pt-2">
                         <label for="numQuestions" class="text-sm font-medium">Number of Questions:</label>
                         <input type="number" id="numQuestions" class="input-field w-24" value="5" min="5" max="150">
                    </div>
                    <button id="generateBtn" class="btn btn-primary w-full flex items-center justify-center gap-2" onclick="generateQuestionsFromText()">
                        <span id="generateBtnText">Generate Questions with AI</span>
                        <div id="generateLoader" class="loader hidden"></div>
                    </button>
                </div>

                <!-- Manual Input Form -->
                <div id="manualInput" class="hidden space-y-4">
                    <input type="text" id="manualQuestion" class="input-field" placeholder="Question">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="manualOptionA" class="input-field" placeholder="Option A">
                        <input type="text" id="manualOptionB" class="input-field" placeholder="Option B">
                        <input type="text" id="manualOptionC" class="input-field" placeholder="Option C">
                        <input type="text" id="manualOptionD" class="input-field" placeholder="Option D">
                    </div>
                    <select id="manualCorrectAnswer" class="input-field">
                        <option value="A">Correct Answer is A</option>
                        <option value="B">Correct Answer is B</option>
                        <option value="C">Correct Answer is C</option>
                        <option value="D">Correct Answer is D</option>
                    </select>
                    <button class="btn btn-secondary w-full" onclick="addManualQuestion()">Add Question</button>
                </div>

                <!-- PDF Upload Form -->
                <div id="pdfInput" class="hidden space-y-6">
                    <label for="pdfFile" class="block w-full cursor-pointer border-2 border-dashed border-[#EFEBE4] rounded-lg p-10 text-center hover:border-[#F7971E] transition-all">
                        <span id="pdfFileName">Click to choose a PDF</span>
                        <input type="file" id="pdfFile" class="hidden" accept="application/pdf" onchange="displayPdfName()">
                    </label>
                    <div class="flex items-center gap-4">
                        <div>
                            <label for="startPage" class="block text-sm font-medium mb-2">Start Page</label>
                            <input type="number" id="startPage" class="input-field w-28" placeholder="First">
                        </div>
                        <div>
                            <label for="endPage" class="block text-sm font-medium mb-2">End Page</label>
                            <input type="number" id="endPage" class="input-field w-28" placeholder="Last">
                        </div>
                    </div>
                    <div class="text-xs p-3 bg-white/50 rounded-lg border border-[#EFEBE4]">
                       <p class="font-semibold">Upload any text-based PDF to extract its content for AI question generation.</p>
                    </div>
                    <button id="parsePdfBtn" class="btn btn-secondary w-full" onclick="handlePdfUpload()" disabled>Extract Text for AI</button>
                </div>

                 <div id="message-box" class="hidden mt-4 p-3 rounded-md text-sm"></div>
            </div>

            <!-- Question List and Start Button -->
            <div class="border-t border-[#EFEBE4] pt-8">
                <h3 class="text-3xl font-semibold text-center mb-4">Question Bank (<span id="questionCount">0</span>)</h3>
                <ul id="questionList" class="list-disc list-inside mt-2 max-h-40 overflow-y-auto"></ul>
                
                <div id="resumeContainer" class="hidden mt-6 p-4 bg-[#D4AF37]/10 border border-[#D4AF37]/20 rounded-lg text-center">
                    <p class="font-semibold text-[#B88917]">You have a quiz in progress!</p>
                    <button class="btn btn-secondary mt-2 w-full" onclick="resumeQuiz()">Resume from where you left off</button>
                </div>

                <button id="startQuizBtn" class="btn btn-primary w-full mt-6" onclick="showGoalModal()" disabled>Start a New Quiz</button>
            </div>
        </div>

        <!-- Quiz Screen -->
        <div id="quizScreen" class="hidden card max-w-4xl mx-auto">
            <div id="horizontalNavContainer" class="hidden">
                 <div id="questionNavGrid"></div>
            </div>
            <div id="quizMainContent">
                <div class="flex justify-between items-center mb-6 text-lg">
                    <div class="font-bold text-xl flex items-center gap-4">Question <span id="currentQuestionNumber"></span>/<span id="totalQuizQuestions"></span>
                        <span id="difficultyTagContainer"></span>
                    </div>
                    <div id="mainTimerDisplay" class="font-mono bg-red-100 text-red-800 px-4 py-2 rounded-lg hidden">Time Left: <span id="quizTimeRemaining"></span></div>
                    <div id="questionTimerDisplay" class="font-mono bg-[#E6E9F0] text-[#414345] px-4 py-2 rounded-lg">Time on Q: <span id="questionTimer">0.0</span>s</div>
                </div>
                <div id="categoryFilters"></div>
                <div id="quizQuestion" class="text-2xl mb-8 leading-relaxed"></div>
                <div id="quizOptions" class="space-y-4"></div>
                <div id="explanationContainer" class="mt-6"></div>
                <div class="flex flex-col md:flex-row gap-4 mt-10">
                    <button id="prevQuestionBtn" class="btn btn-secondary w-full md:w-auto" onclick="prevQuestion()">Previous</button>
                    <div class="flex-grow"></div>
                    <button id="skipQuestionBtn" class="btn btn-secondary w-full md:w-auto" onclick="skipQuestion()">Skip</button>
                    <button id="nextQuestionBtn" class="btn btn-primary w-full md:w-1/3" onclick="nextQuestion()">Next</button>
                </div>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="resultsScreen" class="hidden card space-y-8">
            <div class="text-center"><h1 class="text-4xl font-bold">Quiz Results</h1></div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 text-center">
                <div class="p-4 result-box"><div class="text-sm uppercase tracking-wider">Your Score</div><div id="finalScore" class="text-3xl font-bold mt-1" style="color: #F7971E"></div></div>
                <div class="p-4 result-box"><div class="text-sm uppercase tracking-wider">Accuracy</div><div id="accuracy" class="text-3xl font-bold mt-1" style="color: #F7971E"></div></div>
                <div class="p-4 result-box"><div class="text-sm uppercase tracking-wider">Avg. Speed</div><div id="avgSpeed" class="text-3xl font-bold mt-1" style="color: #F7971E"></div></div>
                <div class="p-4 result-box"><div class="text-sm uppercase tracking-wider">Total Time</div><div id="totalTime" class="text-3xl font-bold mt-1" style="color: #F7971E"></div></div>
            </div>

            <div id="goalAnalysis" class="goal-analysis-box"><h3 class="text-2xl font-semibold mb-3">Goal Analysis</h3><p id="goalAnalysisText" class="text-lg"></p></div>
            
            <div class="mt-8 grid grid-cols-1 lg:grid-cols-5 gap-8 items-start">
                <div class="lg:col-span-2 w-full">
                    <h3 class="text-2xl font-semibold mb-4 text-center">Performance Analysis</h3>
                    <div class="relative h-64 md:h-80 lg:h-96"><canvas id="resultsChart"></canvas></div>
                </div>
                <div class="lg:col-span-3">
                    <h3 class="text-2xl font-semibold mb-4 text-center">Detailed Breakdown</h3>
                    <div class="max-h-96 overflow-y-auto space-y-2 pr-2">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs uppercase bg-[#FAF7F2] sticky top-0"><tr class="text-[#0D1B2A]"><th scope="col" class="px-6 py-3">Q#</th><th scope="col" class="px-6 py-3">Result</th><th scope="col" class="px-6 py-3">Time</th><th scope="col" class="px-6 py-3">Difficulty</th></tr></thead>
                            <tbody id="resultsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="reviewMistakesContainer" class="hidden border-t border-[#EFEBE4] pt-8">
                <h3 class="text-2xl font-semibold mb-6 text-center">Review Your Mistakes</h3>
                <div id="incorrectQuestionsList" class="space-y-6">
                    <!-- Incorrect questions will be dynamically inserted here -->
                </div>
            </div>
            
            <div class="flex flex-col md:flex-row gap-4 mt-6">
                 <button id="reattemptBtn" class="btn btn-secondary w-full hidden" onclick="startMistakesQuiz()"></button>
                 <button class="btn btn-primary w-full" onclick="restart()">Practice Again</button>
            </div>
        </div>
    </div>
    
    <!-- Goal Setting Modal -->
    <div id="goalModal" class="hidden" onclick="hideGoalModal(event)">
        <div class="card w-full max-w-2xl space-y-8" onclick="event.stopPropagation()">
            <h2 class="text-3xl font-semibold text-center">Set Goals & Practice Mode</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label for="goalCorrectModal" class="block text-sm font-medium mb-2">Correct Answers Target</label>
                    <input type="number" id="goalCorrectModal" class="input-field" placeholder="e.g., 18">
                </div>
                <div>
                    <label for="goalTotalModal" class="block text-sm font-medium mb-2">Total Questions in Goal</label>
                    <input type="number" id="goalTotalModal" class="input-field" placeholder="e.g., 20">
                </div>
                 <div>
                    <label for="timeLimitModal" class="block text-sm font-medium mb-2">Time Limit (minutes)</label>
                    <input type="number" id="timeLimitModal" class="input-field" placeholder="e.g., 30">
                </div>
            </div>
            <div class="toggle-container">
                <label for="practiceModeToggle" class="font-semibold text-lg">Practice Mode <span class="text-sm font-normal">(Instant Feedback)</span></label>
                <label class="toggle-switch">
                    <input type="checkbox" id="practiceModeToggle">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="flex flex-col md:flex-row gap-4 pt-4">
                <button class="btn btn-secondary w-full" onclick="startQuiz(true)">Skip & Start</button>
                <button class="btn btn-primary w-full" onclick="startQuiz(false)">Start Quiz</button>
            </div>
        </div>
    </div>

    <footer class="text-center py-6 mt-6 w-full max-w-5xl mx-auto">
        <p id="copyright-notice" class="text-sm"></p>
    </footer>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js`;

        // State variables
        const STORAGE_KEY = 'mcqQuizProgress';
        let questions = []; // This holds all questions from the bank
        let currentQuizQuestions = []; // This holds the currently active (possibly filtered) questions
        let originalQuestions = [];
        let userAnswers = [];
        let goal = { correct: 0, total: 0 };
        let currentQuestionIndex = 0;
        let questionStartTime;
        let questionTimerInterval;
        let quizTimerInterval;
        let quizTimeLimitSeconds = 0;
        let resultsChart;
        let quizMistakes = [];
        let isReattempting = false;
        let isPracticeMode = false;

        // --- SETUP LOGIC ---
        function switchTab(tabName) {
            const tabs = { generate: document.getElementById('generateInput'), manual: document.getElementById('manualInput'), pdf: document.getElementById('pdfInput') };
            const tabButtons = { generate: document.getElementById('generateTab'), manual: document.getElementById('manualTab'), pdf: document.getElementById('pdfTab') };
            for (const key in tabs) {
                tabs[key].classList.add('hidden');
                tabButtons[key].classList.remove('active');
            }
            tabs[tabName].classList.remove('hidden');
            tabButtons[tabName].classList.add('active');
        }

        function showMessage(message, isError = false) {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            messageBox.classList.remove('hidden');
            messageBox.className = `mt-4 p-3 rounded-md text-sm ${isError ? 'bg-red-100 text-red-800' : 'bg-[#D4AF37]/20 text-[#B88917]'}`;
            setTimeout(() => messageBox.classList.add('hidden'), 5000);
        }
        
        async function addAndCategorizeQuestions(newQuestions) {
            const existingQuestionCount = questions.length;
            questions.push(...newQuestions);
            
            showMessage('Categorizing new questions with AI...', false);
            const questionTexts = newQuestions.map(q => q.question);

            try {
                const apiKey = "AIzaSyBmCdq0-NrCTSPi8hcPlLhRptXsI4OjiTY"; 
                if (!apiKey) throw new Error("API key is missing.");

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const systemPrompt = `You are a helpful assistant that categorizes quiz questions. Classify each question into one of the following categories ONLY: Math, English, Reasoning, General Knowledge. Respond with a valid JSON array of strings, where each string is the category for the corresponding question in the input array. Example response: ["Math", "General Knowledge", "Reasoning"]`;
                const userPrompt = JSON.stringify(questionTexts);

                const payload = {
                    contents: [{ parts: [{ text: userPrompt }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };
                
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);

                const result = await response.json();
                let categoryText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (categoryText) {
                    const jsonMatch = categoryText.match(/\[.*\]/s);
                    if (jsonMatch) {
                        categoryText = jsonMatch[0];
                    }
                }

                const categories = JSON.parse(categoryText);

                if (categories && categories.length === newQuestions.length) {
                    newQuestions.forEach((q, index) => {
                        questions[existingQuestionCount + index].category = categories[index] || "General Knowledge";
                    });
                    showMessage('Questions categorized successfully!', false);
                } else {
                    throw new Error("Category array mismatch.");
                }
            } catch (error) {
                console.error("Categorization Error:", error);
                showMessage('Could not categorize questions. Assigning default category.', true);
                newQuestions.forEach((q, index) => {
                    questions[existingQuestionCount + index].category = "General Knowledge";
                });
            }
            updateQuestionList();
        }

        function addManualQuestion() {
            const question = document.getElementById('manualQuestion').value.trim();
            const options = { A: document.getElementById('manualOptionA').value.trim(), B: document.getElementById('manualOptionB').value.trim(), C: document.getElementById('manualOptionC').value.trim(), D: document.getElementById('manualOptionD').value.trim() };
            const correctAnswer = document.getElementById('manualCorrectAnswer').value;
            if (question && options.A && options.B && options.C && options.D) {
                addAndCategorizeQuestions([{ question, options, correctAnswer, difficulty: 'Medium' }]); // Default difficulty for manual
                document.getElementById('manualQuestion').value = '';
                document.getElementById('manualOptionA').value = '';
                document.getElementById('manualOptionB').value = '';
                document.getElementById('manualOptionC').value = '';
                document.getElementById('manualOptionD').value = '';
            } else {
                showMessage('Please fill out all fields for the question.', true);
            }
        }

        function parseAndAddQuestions(text, fromAI = false) {
            if (!text || text.trim() === '') { showMessage('The text is empty. Please check your source.', true); return 0; }
            const questionRegex = /(?:\d+[\.\)]|\*\s)\s*(.*?)\s*\n\s*[A-Da-d]\)\s*(.*?)\s*\n\s*[A-Da-d]\)\s*(.*?)\s*\n\s*[A-Da-d]\)\s*(.*?)\s*\n\s*[A-Da-d]\)\s*(.*?)\s*\n\s*(?:Answer|Correct):\s*([A-D])\s*\n?\s*(?:Difficulty:\s*(Easy|Medium|Hard))?/gi;
            let match;
            let newQuestions = [];
            while ((match = questionRegex.exec(text.trim())) !== null) {
                const [, question, optA, optB, optC, optD, correctAnswer, difficulty] = match;
                newQuestions.push({ 
                    question: question.trim(), 
                    options: { A: optA.trim(), B: optB.trim(), C: optC.trim(), D: optD.trim() }, 
                    correctAnswer: correctAnswer.trim().toUpperCase(),
                    difficulty: difficulty || 'Medium'
                });
            }
            
            if (newQuestions.length > 0) {
                 if(fromAI){
                    addAndCategorizeQuestions(newQuestions);
                 } else {
                    questions.push(...newQuestions)
                    updateQuestionList();
                 }
                 return newQuestions.length;
            } else {
                showMessage('Could not find pre-formatted questions in the provided text.', true);
                return 0;
            }
        }
        
        function updateQuestionList() {
            document.getElementById('questionCount').textContent = questions.length;
            document.getElementById('questionList').innerHTML = questions.map((q, i) => `<li class="py-1">${i+1}. ${q.question.substring(0, 40)}... [${q.category || 'N/A'} / ${q.difficulty}]</li>`).join('');
            document.getElementById('startQuizBtn').disabled = questions.length === 0;
        }

        function displayPdfName() {
            const fileInput = document.getElementById('pdfFile');
            const fileNameSpan = document.getElementById('pdfFileName');
            const parseBtn = document.getElementById('parsePdfBtn');
            if (fileInput.files.length > 0) {
                fileNameSpan.textContent = fileInput.files[0].name;
                fileNameSpan.classList.add('font-semibold');
                parseBtn.disabled = false;
            } else {
                fileNameSpan.textContent = 'Click to choose a PDF';
                fileNameSpan.classList.remove('font-semibold');
                parseBtn.disabled = true;
            }
        }

        async function handlePdfUpload() {
            const fileInput = document.getElementById('pdfFile');
            if (fileInput.files.length === 0) { showMessage('Please select a PDF file first.', true); return; }
            const startPageInput = document.getElementById('startPage').value;
            const endPageInput = document.getElementById('endPage').value;
            const file = fileInput.files[0];
            const parseBtn = document.getElementById('parsePdfBtn');
            parseBtn.textContent = 'Extracting Text...';
            parseBtn.disabled = true;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const typedarray = new Uint8Array(e.target.result);
                    const pdf = await pdfjsLib.getDocument(typedarray).promise;
                    const maxPages = pdf.numPages;
                    let startPage = startPageInput ? parseInt(startPageInput) : 1;
                    let endPage = endPageInput ? parseInt(endPageInput) : maxPages;

                    if (isNaN(startPage) || isNaN(endPage) || startPage < 1 || startPage > maxPages || endPage < 1 || endPage > maxPages || startPage > endPage) {
                        showMessage(`Invalid page range. Please enter numbers between 1 and ${maxPages}.`, true);
                        throw new Error('Invalid page range');
                    }

                    let fullText = '';
                    for (let i = startPage; i <= endPage; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        fullText += textContent.items.map(item => item.str).join(' ') + '\n\n';
                    }
                    
                    document.getElementById('aiContext').value = fullText.trim();
                    switchTab('generate');
                    showMessage(`Text extracted from pages ${startPage}-${endPage}. You can now generate questions.`);
                } catch (error) {
                    console.error('Error handling PDF:', error);
                    if (error.message !== 'Invalid page range') showMessage('Failed to parse PDF. Ensure it is a valid, text-based PDF.', true);
                } finally {
                    parseBtn.textContent = 'Extract Text for AI';
                    if (fileInput.files.length > 0) parseBtn.disabled = false;
                }
            };
            reader.readAsArrayBuffer(file);
        }

        async function generateQuestionsFromText() {
            const topic = document.getElementById('aiTopic').value.trim();
            const context = document.getElementById('aiContext').value.trim();
            const style = document.getElementById('aiStyle').value.trim();
            const examples = document.getElementById('aiExamples').value.trim();
            const numQs = document.getElementById('numQuestions').value;

            if (!topic && context.length < 20) {
                showMessage("Please provide a topic or a more detailed paragraph.", true); return;
            }

            const generateBtn = document.getElementById('generateBtn');
            const btnText = document.getElementById('generateBtnText');
            const loader = document.getElementById('generateLoader');
            btnText.textContent = 'Generating...';
            loader.classList.remove('hidden');
            generateBtn.disabled = true;
            
            try {
                const apiKey = "AIzaSyBmCdq0-NrCTSPi8hcPlLhRptXsI4OjiTY"; 
                if (!apiKey) throw new Error("API key is missing.");

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                let userPrompt = `Generate exactly ${numQs} multiple-choice questions.`;
                if (topic) userPrompt += `\nThe topic is "${topic}".`;
                if (context) userPrompt += `\nBase the questions on the following context: "${context}".`;
                if (style) userPrompt += `\nFollow these instructions for question style: "${style}".`;
                if (examples) userPrompt += `\nGenerate new questions that are similar in format and difficulty to these examples:\n${examples}`;
                const systemPrompt = `You are an expert quiz creator. Format the output STRICTLY as follows, with each question separated by a blank line:\n\n1. Question text?\nA) Option A\nB) Option B\nC) Option C\nD) Option D\nCorrect: C\nDifficulty: Easy`;
                const payload = { contents: [{ parts: [{ text: userPrompt }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };

                let response;
                let attempts = 0;
                const maxRetries = 3;
                let delay = 1000;

                while(attempts < maxRetries) {
                    try {
                        response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        if (response.ok) break;
                        
                        if (response.status >= 500) {
                             console.log(`Attempt ${attempts + 1} failed with server error ${response.status}. Retrying in ${delay / 1000}s...`);
                             await new Promise(res => setTimeout(res, delay));
                             delay *= 2;
                             attempts++;
                             continue;
                        }

                        let errorDetails = `API Error: Status ${response.status}`;
                        try {
                            const errorData = await response.json();
                            errorDetails = errorData.error?.message || JSON.stringify(errorData);
                        } catch (e) {
                            errorDetails += ` - ${await response.text()}`;
                        }
                        throw new Error(errorDetails);

                    } catch(error) {
                        console.log(`Attempt ${attempts + 1} failed with network error. Retrying in ${delay / 1000}s...`);
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                        attempts++;
                    }
                }

                if (!response || !response.ok) {
                    throw new Error("The service is currently unavailable. Please try again later.");
                }

                const result = await response.json();
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (generatedText) {
                    if (parseAndAddQuestions(generatedText, true) === 0) {
                        showMessage("AI response couldn't be formatted into questions. Try again.", true);
                        console.log("AI Raw Response:", generatedText);
                    }
                } else { throw new Error("The AI returned an empty response."); }
            } catch (error) {
                console.error("AI Generation Error:", error);
                let userMessage = `An error occurred with the AI service. Error: ${error.message}`;
                if (error.message.includes("API key is missing")) userMessage = "AI feature is not configured. Please add your API key.";
                showMessage(userMessage, true);
            } finally {
                btnText.textContent = 'Generate Questions with AI';
                loader.classList.add('hidden');
                generateBtn.disabled = false;
            }
        }
        
        // --- GOAL MODAL LOGIC ---
        function showGoalModal() {
            if (questions.length === 0) {
                showMessage('Please add questions before starting.', true);
                return;
            }
            document.getElementById('goalModal').style.display = 'flex';
        }

        function hideGoalModal(event) {
            if (event.target.id === 'goalModal') {
                 document.getElementById('goalModal').style.display = 'none';
            }
        }

        // --- QUIZ LOGIC ---
        function startQuiz(skipped = false) {
            document.getElementById('goalModal').style.display = 'none';
            isPracticeMode = document.getElementById('practiceModeToggle').checked;

            clearSavedProgress();

            if (skipped) {
                document.getElementById('goalCorrectModal').value = '';
                document.getElementById('goalTotalModal').value = '';
                document.getElementById('timeLimitModal').value = '';
            }

            const goalCorrect = parseInt(document.getElementById('goalCorrectModal').value);
            const goalTotal = parseInt(document.getElementById('goalTotalModal').value);
            const timeLimitMinutes = parseInt(document.getElementById('timeLimitModal').value);
            
            goal = (!isNaN(goalCorrect) && !isNaN(goalTotal) && goalCorrect > 0 && goalTotal > 0) ? { correct: goalCorrect, total: goalTotal } : { correct: 0, total: 0 };
            
            if (!isNaN(timeLimitMinutes) && timeLimitMinutes > 0 && !isPracticeMode) {
                quizTimeLimitSeconds = timeLimitMinutes * 60;
                startQuizTimer();
                document.getElementById('mainTimerDisplay').classList.remove('hidden');
            } else {
                 quizTimeLimitSeconds = 0;
                 document.getElementById('mainTimerDisplay').classList.add('hidden');
            }
            
            if (isPracticeMode) {
                document.getElementById('mainTimerDisplay').classList.add('hidden');
                document.getElementById('questionTimerDisplay').classList.add('hidden');
            } else {
                document.getElementById('questionTimerDisplay').classList.remove('hidden');
            }

            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('quizScreen').classList.remove('hidden');
            document.getElementById('horizontalNavContainer').classList.remove('hidden');
            
            setupCategoryFilters();
            filterQuestions('All'); // Start with all questions
        }

        function setupCategoryFilters() {
            const categories = ['All', ...new Set(questions.map(q => q.category).filter(Boolean))];
            const filterContainer = document.getElementById('categoryFilters');
            filterContainer.innerHTML = '';
            categories.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.textContent = category;
                btn.dataset.category = category;
                if (category === 'All') btn.classList.add('active');
                btn.onclick = () => filterQuestions(category);
                filterContainer.appendChild(btn);
            });
        }
        
        function filterQuestions(category) {
            document.querySelectorAll('#categoryFilters .category-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`#categoryFilters .category-btn[data-category="${category}"]`).classList.add('active');

            if(category === 'All') {
                currentQuizQuestions = [...questions];
            } else {
                currentQuizQuestions = questions.filter(q => q.category === category);
            }
            
            if(currentQuizQuestions.length === 0) {
                showMessage(`No questions found for the category: ${category}. Showing all questions.`, true);
                filterQuestions('All');
                return;
            }

            userAnswers = new Array(questions.length).fill(null);
            currentQuestionIndex = 0;
            renderNav();
            loadQuestion();
        }

        function renderNav() {
            const navGrid = document.getElementById('questionNavGrid');
            navGrid.innerHTML = '';
            currentQuizQuestions.forEach((q, index) => {
                const navItem = document.createElement('div');
                navItem.className = 'nav-item';
                navItem.textContent = index + 1;
                navItem.onclick = () => jumpToQuestion(index);
                navGrid.appendChild(navItem);
            });
        }
        
        function updateNav() {
            const navItems = document.querySelectorAll('#questionNavGrid .nav-item');
            navItems.forEach((item, index) => {
                const originalIndex = questions.indexOf(currentQuizQuestions[index]);
                const answer = userAnswers[originalIndex];
                item.classList.remove('current', 'attempted', 'skipped');
                if (answer) {
                    if (answer.answer === 'SKIPPED') item.classList.add('skipped');
                    else item.classList.add('attempted');
                }
                if (index === currentQuestionIndex) {
                    item.classList.add('current');
                    item.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                }
            });
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < currentQuizQuestions.length) {
                currentQuestionIndex = index;
                loadQuestion();
            }
        }

        function loadQuestion() {
            if (currentQuestionIndex >= currentQuizQuestions.length) { 
                if (currentQuestionIndex > 0 && userAnswers[questions.indexOf(currentQuizQuestions[currentQuestionIndex-1])] != null) {
                    endQuiz();
                }
                return; 
            }
            stopQuestionTimer();
            const q = currentQuizQuestions[currentQuestionIndex];
            const originalIndex = questions.indexOf(q);

            document.getElementById('currentQuestionNumber').textContent = currentQuestionIndex + 1;
            document.getElementById('totalQuizQuestions').textContent = currentQuizQuestions.length;

            const quizQuestionEl = document.getElementById('quizQuestion');
            quizQuestionEl.textContent = q.question;
            if (window.MathJax) {
                window.MathJax.typesetPromise([quizQuestionEl]).catch((err) => console.log('MathJax typeset error:', err));
            }
            
            const difficultyContainer = document.getElementById('difficultyTagContainer');
            const difficulty = q.difficulty || 'Medium';
            difficultyContainer.innerHTML = `<span class="difficulty-tag difficulty-${difficulty.toLowerCase()}">${difficulty}</span>`;

            document.getElementById('explanationContainer').innerHTML = ''; // Clear previous explanation

            const optionsContainer = document.getElementById('quizOptions');
            optionsContainer.innerHTML = '';
            
            const previousAnswer = userAnswers[originalIndex];
            
            Object.entries(q.options).forEach(([key, value]) => {
                const optionEl = document.createElement('div');
                optionEl.className = 'option p-4 cursor-pointer';
                optionEl.textContent = `${key}: ${value}`;
                optionEl.dataset.option = key;
                optionEl.onclick = () => selectOption(key);
                optionEl.style.pointerEvents = 'auto'; // Reset clickability
                if (previousAnswer && previousAnswer.answer === key) {
                    optionEl.classList.add('selected');
                }
                optionsContainer.appendChild(optionEl);
            });
            
            document.getElementById('prevQuestionBtn').disabled = currentQuestionIndex === 0;
            const nextButton = document.getElementById('nextQuestionBtn');
            nextButton.disabled = !previousAnswer || !previousAnswer.answer || previousAnswer.answer === 'SKIPPED';
            if (currentQuestionIndex === currentQuizQuestions.length - 1) {
                nextButton.textContent = "Finish";
            } else {
                nextButton.textContent = "Next";
            }
            
            if(!isPracticeMode) startQuestionTimer();
            updateNav();
        }

        function selectOption(optionKey) {
             if (isPracticeMode && document.querySelector('.option.correct, .option.incorrect')) {
                return; // Answer already locked in for this question
            }
            
            document.querySelectorAll('.option').forEach(el => {
                el.classList.remove('selected');
                if (el.dataset.option === optionKey) el.classList.add('selected');
            });

            if(isPracticeMode) {
                const q = currentQuizQuestions[currentQuestionIndex];
                const correctAnswer = q.correctAnswer;
                const allOptions = document.querySelectorAll('.option');
                allOptions.forEach(el => el.style.pointerEvents = 'none'); // Disable all options

                const selectedEl = document.querySelector(`.option[data-option="${optionKey}"]`);
                if (optionKey === correctAnswer) {
                    selectedEl.classList.add('correct');
                } else {
                    selectedEl.classList.add('incorrect');
                    const correctEl = document.querySelector(`.option[data-option="${correctAnswer}"]`);
                    if(correctEl) correctEl.classList.add('correct-answer');
                }

                const explanationContainer = document.getElementById('explanationContainer');
                explanationContainer.innerHTML = `<button id="explainBtn" class="btn btn-secondary w-full mt-4" onclick="getExplanation()">Show Explanation</button>`;
            }

            document.getElementById('nextQuestionBtn').disabled = false;
        }
        
        async function getExplanation() {
            const explainBtn = document.getElementById('explainBtn');
            if(explainBtn) {
                explainBtn.innerHTML = `<span class="loader" style="border-color: #3E4C59; border-bottom-color: transparent;"></span> Generating...`;
                explainBtn.disabled = true;
            }

            const q = currentQuizQuestions[currentQuestionIndex];
            const prompt = `Explain why the correct answer for the following multiple-choice question is "${q.correctAnswer}". Also, briefly explain why the other options are incorrect.\n\nQuestion: ${q.question}\nOptions:\nA) ${q.options.A}\nB) ${q.options.B}\nC) ${q.options.C}\nD) ${q.options.D}\nCorrect Answer: ${q.correctAnswer}`;

            try {
                const apiKey = "AIzaSyBmCdq0-NrCTSPi8hcPlLhRptXsI4OjiTY"; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };

                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error("Failed to fetch explanation.");

                const result = await response.json();
                const explanationText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (explanationText) {
                    document.getElementById('explanationContainer').innerHTML = `
                        <div id="explanationBox">
                            <h4>Explanation</h4>
                            <p>${explanationText.replace(/\n/g, '<br>')}</p>
                        </div>
                    `;
                } else {
                    throw new Error("Empty explanation response from AI.");
                }
            } catch (error) {
                console.error("Explanation Error:", error);
                document.getElementById('explanationContainer').innerHTML = `<p class="text-red-500 mt-4">Could not load explanation. Please try again.</p>`;
            }
        }
        
        function processAnswer(answerValue) {
            if(!isPracticeMode) stopQuestionTimer();

            const timeTaken = isPracticeMode ? 0 : parseFloat(document.getElementById('questionTimer').textContent);
            
            const q = currentQuizQuestions[currentQuestionIndex];
            const originalIndex = questions.indexOf(q);

            const existingAnswer = userAnswers[originalIndex];
            const cumulativeTime = (existingAnswer && existingAnswer.timeTaken) ? existingAnswer.timeTaken + timeTaken : timeTaken;

            userAnswers[originalIndex] = {
                answer: answerValue,
                timeTaken: cumulativeTime
            };
            
            if (currentQuestionIndex < currentQuizQuestions.length - 1) {
                currentQuestionIndex++;
                if (!isReattempting) saveProgress();
                loadQuestion();
            } else {
                endQuiz();
            }
        }
        
        function nextQuestion() {
            const selectedOption = document.querySelector('.option.selected');
            if (!selectedOption) return;
            processAnswer(selectedOption.dataset.option);
        }
        
        function skipQuestion() {
            processAnswer('SKIPPED');
        }
        
        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                stopQuestionTimer();
                currentQuestionIndex--;
                loadQuestion();
            }
        }

        function startQuestionTimer() {
            questionStartTime = Date.now();
            questionTimerInterval = setInterval(() => { 
                document.getElementById('questionTimer').textContent = ((Date.now() - questionStartTime) / 1000).toFixed(1); 
            }, 100);
        }

        function stopQuestionTimer() { clearInterval(questionTimerInterval); }
        
        function startQuizTimer() {
            const timerEl = document.getElementById('quizTimeRemaining');
            const initialMinutes = Math.floor(quizTimeLimitSeconds / 60);
            const initialSeconds = quizTimeLimitSeconds % 60;
            timerEl.textContent = `${initialMinutes.toString().padStart(2, '0')}:${initialSeconds.toString().padStart(2, '0')}`;
            
            quizTimerInterval = setInterval(() => {
                if (quizTimeLimitSeconds > 0) {
                    quizTimeLimitSeconds--;
                }
                const minutes = Math.floor(quizTimeLimitSeconds / 60);
                const seconds = quizTimeLimitSeconds % 60;
                timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                if (quizTimeLimitSeconds <= 0) {
                    endQuiz();
                    showMessage("Time's up!", true);
                }
            }, 1000);
        }

        // --- RESULTS LOGIC ---
        function endQuiz() {
            stopQuestionTimer();
            clearInterval(quizTimerInterval);
            
            if (isReattempting) {
                isReattempting = false;
                questions = [...originalQuestions];
            }
            
            clearSavedProgress();
            document.getElementById('quizScreen').classList.add('hidden');
            document.getElementById('horizontalNavContainer').classList.add('hidden');
            document.getElementById('resultsScreen').classList.remove('hidden');
            calculateResults();
        }
        
        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = Math.floor(totalSeconds % 60);
            return `${minutes}m ${seconds.toFixed(0)}s`;
        }

        function calculateResults() {
            let correctCount = 0;
            let totalTime = 0;
            let answeredCount = 0;
            quizMistakes = [];
            
            questions.forEach((question, index) => {
                const ans = userAnswers[index];
                let isCorrect = false;

                if (ans) {
                    answeredCount++;
                    totalTime += ans.timeTaken;
                    if (question.correctAnswer === ans.answer) {
                        isCorrect = true;
                        correctCount++;
                    }
                }
                
                if (!isCorrect) {
                    quizMistakes.push(question);
                }
            });

            const reattemptBtn = document.getElementById('reattemptBtn');
            if (quizMistakes.length > 0) {
                reattemptBtn.classList.remove('hidden');
                reattemptBtn.textContent = `Re-attempt Incomplete (${quizMistakes.length})`;
            } else {
                reattemptBtn.classList.add('hidden');
            }

            const accuracy = questions.length > 0 ? (correctCount / questions.length) * 100 : 0;
            const avgSpeed = answeredCount > 0 ? totalTime / answeredCount : 0;
            document.getElementById('finalScore').textContent = `${correctCount}/${questions.length}`;
            document.getElementById('accuracy').textContent = `${accuracy.toFixed(1)}%`;
            document.getElementById('avgSpeed').textContent = `${avgSpeed.toFixed(2)}s/q`;
            document.getElementById('totalTime').textContent = formatTime(totalTime);
            
            const goalAnalysisEl = document.getElementById('goalAnalysis');
            const goalAnalysisTextEl = document.getElementById('goalAnalysisText');
            if (goal.total > 0) {
                const goalAccuracy = (goal.correct / goal.total) * 100;
                let analysisMsg = `Your goal was ${goal.correct}/${goal.total} (${goalAccuracy.toFixed(1)}%). Your accuracy was ${accuracy.toFixed(1)}%.`;
                if(accuracy >= goalAccuracy) {
                    analysisMsg += " Congratulations, you've met your goal!";
                    goalAnalysisEl.className = 'goal-analysis-box bg-[#D4AF37]/10 text-[#B88917]';
                } else {
                    const difference = goal.correct - Math.round(correctCount * (goal.total/questions.length));
                    analysisMsg += ` You are about ${difference > 0 ? difference : 1} correct answer(s) short of your scaled goal. Keep practicing!`;
                    goalAnalysisEl.className = 'goal-analysis-box bg-red-100/80 text-red-800';
                }
                goalAnalysisTextEl.textContent = analysisMsg;
            } else {
                 goalAnalysisEl.className = 'goal-analysis-box bg-[#FAF7F2] text-[#3E4C59]';
                 goalAnalysisTextEl.textContent = "You didn't set a goal. Set one next time to track progress!";
            }

            const tableBody = document.getElementById('resultsTableBody');
            tableBody.innerHTML = '';
            questions.forEach((question, index) => {
                const ans = userAnswers[index];
                let resultHtml;
                let timeText = ans ? `${ans.timeTaken.toFixed(1)}s` : 'N/A';
                
                if (!ans) {
                    resultHtml = `<span class="px-2 py-1 rounded-full text-xs font-semibold bg-gray-200 text-gray-800">Unanswered</span>`;
                } else if (ans.answer === 'SKIPPED') {
                    resultHtml = `<span class="px-2 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800">Skipped</span>`;
                } else {
                    const isCorrect = question.correctAnswer === ans.answer;
                    resultHtml = `<span class="px-2 py-1 rounded-full text-xs font-semibold ${isCorrect ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${isCorrect ? 'Correct' : `Incorrect (Ans: ${question.correctAnswer}, You: ${ans.answer})`}</span>`;
                }
                tableBody.innerHTML += `<tr class="border-b border-[#EFEBE4]"><td class="px-6 py-4 font-medium text-[#0D1B2A]">${index + 1}</td><td class="px-6 py-4">${resultHtml}</td><td class="px-6 py-4">${timeText}</td><td class="px-6 py-4">${question.difficulty}</td></tr>`;
            });
            
            const reviewContainer = document.getElementById('reviewMistakesContainer');
            const incorrectList = document.getElementById('incorrectQuestionsList');
            incorrectList.innerHTML = '';
            const incorrectReviewItems = [];
            questions.forEach((q, index) => {
                const ans = userAnswers[index];
                if (ans && ans.answer !== 'SKIPPED' && q.correctAnswer !== ans.answer) {
                    incorrectReviewItems.push({ question: q, userAnswer: ans.answer });
                }
            });

            if (incorrectReviewItems.length > 0) {
                reviewContainer.classList.remove('hidden');
                incorrectReviewItems.forEach((item, index) => {
                    const q = item.question;
                    const questionEl = document.createElement('div');
                    questionEl.className = 'p-4 rounded-lg bg-white/30 space-y-3';
                    const questionText = document.createElement('p');
                    questionText.className = 'font-semibold';
                    questionText.textContent = `${index + 1}. ${q.question}`;
                    
                    const optionsList = document.createElement('ul');
                    optionsList.className = 'space-y-2';

                    Object.entries(q.options).forEach(([key, value]) => {
                        let styleClass = 'bg-white border-[#EFEBE4]';
                        if (key === item.userAnswer) styleClass = 'bg-red-200/80 border-red-400 text-red-800 font-semibold';
                        if (key === q.correctAnswer) styleClass = 'bg-green-200/80 border-green-400 text-green-800 font-semibold';
                        optionsList.innerHTML += `<li class="p-3 rounded-md border ${styleClass}">${key}: ${value}</li>`;
                    });

                    questionEl.appendChild(questionText);
                    questionEl.appendChild(optionsList);
                    incorrectList.appendChild(questionEl);
                });

                if (window.MathJax) {
                    window.MathJax.typesetPromise([incorrectList]).catch((err) => console.log('MathJax typeset error:', err));
                }
            } else {
                reviewContainer.classList.add('hidden');
            }

            const ctx = document.getElementById('resultsChart').getContext('2d');
            if (resultsChart) { resultsChart.destroy(); }
            const labels = ['Accuracy', 'Speed Score'];
            const yourSpeedScore = avgSpeed > 0 ? Math.min(100, (60 / avgSpeed) * 30) : 0;
            const yourData = [accuracy, yourSpeedScore];
            const datasets = [];
            if (goal.total > 0) {
                labels.push('Goal Achievement');
                const goalAccuracy = (goal.correct / goal.total) * 100;
                const goalProximity = Math.min(100, (accuracy / goalAccuracy) * 100);
                yourData.push(goalProximity);
                const goalData = [goalAccuracy, 75, 100];
                datasets.push({ label: 'Your Goal', data: goalData, backgroundColor: 'rgba(212, 175, 55, 0.1)', borderColor: 'rgba(212, 175, 55, 0.5)', pointBackgroundColor: 'rgba(212, 175, 55, 0.5)' });
            }
            datasets.unshift({ label: 'Your Performance', data: yourData, backgroundColor: 'rgba(40, 167, 69, 0.2)', borderColor: 'rgba(40, 167, 69, 1)', pointBackgroundColor: 'rgba(40, 167, 69, 1)' });
            resultsChart = new Chart(ctx, { type: 'radar', data: { labels: labels, datasets: datasets }, options: { responsive: true, maintainAspectRatio: false, scales: { r: { angleLines: { color: '#EFEBE4' }, grid: { color: '#EFEBE4' }, pointLabels: { font: { size: 12, weight: '500' }, color: '#0D1B2A' }, ticks: { backdropColor: '#FFFFFF', color: '#3E4C59', stepSize: 25 }, min: 0, max: 100 } }, plugins: { legend: { position: 'top', labels: { color: '#0D1B2A' } } } } });
        }

        function startMistakesQuiz() {
            if (quizMistakes.length === 0) return;
            isReattempting = true;
            originalQuestions = [...questions];
            questions = [...quizMistakes];
            
            document.getElementById('resultsScreen').classList.add('hidden');
            document.getElementById('quizScreen').classList.remove('hidden');
            document.getElementById('horizontalNavContainer').classList.remove('hidden');

            setupCategoryFilters();
            filterQuestions('All');
        }
        
        function restart() {
            clearSavedProgress();
            clearInterval(quizTimerInterval);
            questions = [];
            originalQuestions = [];
            quizMistakes = [];
            isReattempting = false;
            updateQuestionList();
            document.getElementById('setupScreen').classList.remove('hidden');
            document.getElementById('quizScreen').classList.add('hidden');
            document.getElementById('resultsScreen').classList.add('hidden');
            document.getElementById('goalCorrectModal').value = '';
            document.getElementById('goalTotalModal').value = '';
            document.getElementById('timeLimitModal').value = '';
            document.getElementById('pdfFile').value = '';
            document.getElementById('reviewMistakesContainer').classList.add('hidden');
            document.getElementById('incorrectQuestionsList').innerHTML = '';
            displayPdfName();
            switchTab('generate');
        }
        
        // --- PROGRESS SAVING LOGIC ---
        function saveProgress() {
            if (isReattempting) return;
            if (currentQuestionIndex >= 0 && currentQuestionIndex < questions.length) {
                const progress = {
                    questions: questions,
                    userAnswers: userAnswers,
                    currentQuestionIndex: currentQuestionIndex,
                    goal: goal,
                    quizTimeLimitSeconds: quizTimeLimitSeconds
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(progress));
            }
        }

        function clearSavedProgress() {
            localStorage.removeItem(STORAGE_KEY);
            document.getElementById('resumeContainer').classList.add('hidden');
        }

        function checkForSavedProgress() {
            const savedProgress = localStorage.getItem(STORAGE_KEY);
            if (savedProgress) {
                document.getElementById('resumeContainer').classList.remove('hidden');
            }
        }

        function resumeQuiz() {
            const savedProgress = localStorage.getItem(STORAGE_KEY);
            if (savedProgress) {
                const progress = JSON.parse(savedProgress);
                questions = progress.questions;
                userAnswers = progress.userAnswers;
                // currentQuestionIndex will be set by filterQuestions
                goal = progress.goal;
                quizTimeLimitSeconds = progress.quizTimeLimitSeconds;
                
                if (quizTimeLimitSeconds > 0) {
                    startQuizTimer();
                }

                document.getElementById('setupScreen').classList.add('hidden');
                document.getElementById('quizScreen').classList.remove('hidden');
                document.getElementById('horizontalNavContainer').classList.remove('hidden');
                
                setupCategoryFilters();
                filterQuestions('All'); // Resume always starts with 'All' filter
                // Now restore the exact index
                currentQuestionIndex = progress.currentQuestionIndex;
                loadQuestion();

            } else {
                showMessage("No saved progress found to resume.", true);
            }
        }


        window.onload = () => {
            switchTab('generate');
            checkForSavedProgress();
            const encodedName = '534148494c205941444156'; // SAHIL YADAV in hex
            try {
                let copyrightHolder = '';
                for (let i = 0; i < encodedName.length; i += 2) {
                    copyrightHolder += String.fromCharCode(parseInt(encodedName.substr(i, 2), 16));
                }
                 document.getElementById('copyright-notice').textContent = ` 2025 ${copyrightHolder}. All Rights Reserved.`;
            } catch (e) {
                console.error("Could not decode copyright name.", e);
            }
        };
    </script>
</body>
</html>

